<html>
    <body>
      <script>
        function fetchAndInstantiateWasm (url, imports) {
            return fetch('jpeg-decode.wasm').then(response =>
                response.arrayBuffer()
            )
            .then(bytes => WebAssembly.compile(bytes))
            .then(module =>
            WebAssembly.instantiate(module, imports || {})
            )
            .then(instance => instance.exports);
        }
        
        let mem, wasmInstance;
        function writeBytes(byteArray, offset) {
            console.log('Offset:' + offset);
            const outBuf = new Uint8Array(mem.buffer, offset, byteArray.length);
            for (let i = 0; i < 2; i++) {
                console.log(byteArray[i]);
                outBuf[i] = byteArray[i];
            }
        }
        fetchAndInstantiateWasm('jpeg-decode.wasm',{
            env: {
              consoleLog (offset, len) {
                const strBuf = new Uint8Array(mem.buffer, offset, len);
                console.log(new TextDecoder().decode(strBuf));
              }
            }
        })
        .then(instance => {
            mem = instance.memory;
            wasmInstance = instance;
        });



        function test() {
            var xhr = new XMLHttpRequest();
            xhr.open('get', 'test.jpg');
            xhr.responseType = 'blob';
            xhr.onload = function(){
                var fr = new FileReader();
                
                fr.onload = function(){
                    let arrayBuffer = this.result;
                    var arr = new Uint8Array(arrayBuffer);
                    console.log(arr);
                    writeBytes(arr, wasmInstance.getInOffset(1000));
                    console.log(wasmInstance.jpeg_decode());
                };
                
                fr.readAsArrayBuffer(xhr.response);
            }
            xhr.send();
        }
      </script>
    </body>
</html>